<UserControl
    x:Class="Unison.UWPApp.UI.Views.ChatDetailView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Unison.UWPApp.UI.Views"
    xmlns:models="using:Unison.UWPApp.Models"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    d:DesignHeight="800"
    d:DesignWidth="800">

    <UserControl.Resources>
        <local:MessageTemplateSelector x:Key="MessageTemplateSelector">
            <local:MessageTemplateSelector.SentTemplate>
                <DataTemplate x:DataType="models:ChatMessage">
                    <Grid HorizontalAlignment="Right" Margin="48,4,12,4">
                        <Border Background="{StaticResource UnisonGreenBrush}" 
                                CornerRadius="16,16,4,16" Padding="12,8">
                            <StackPanel>
                                <TextBlock Text="{x:Bind Content}" Foreground="White" TextWrapping="Wrap" FontSize="15" LineHeight="20"/>
                                <TextBlock Text="{x:Bind FormattedTime}" Foreground="#CCFFFFFF" FontSize="11" HorizontalAlignment="Right" Margin="0,4,0,0" FontFamily="{StaticResource MainFont}"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </DataTemplate>
            </local:MessageTemplateSelector.SentTemplate>
            <local:MessageTemplateSelector.ReceivedTemplate>
                <DataTemplate x:DataType="models:ChatMessage">
                    <Grid HorizontalAlignment="Left" Margin="12,4,48,4">
                        <Border Background="{ThemeResource SystemControlBackgroundBaseMediumLowBrush}" 
                                CornerRadius="16,16,16,4" Padding="12,8">
                            <StackPanel>
                                <TextBlock Text="{x:Bind Content}" Foreground="{ThemeResource SystemControlForegroundBaseHighBrush}" TextWrapping="Wrap" FontSize="15" LineHeight="20" FontFamily="{StaticResource MainFont}"/>
                                <TextBlock Text="{x:Bind FormattedTime}" Foreground="{ThemeResource SystemControlForegroundBaseLowBrush}" FontSize="11" HorizontalAlignment="Right" Margin="0,4,0,0" FontFamily="{StaticResource MainFont}"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </DataTemplate>
            </local:MessageTemplateSelector.ReceivedTemplate>
        </local:MessageTemplateSelector>
    </UserControl.Resources>

    <Grid x:Name="ChatDetailGrid" Background="{ThemeResource SystemControlBackgroundAltHighBrush}">
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="LayoutStates">
                <VisualState x:Name="WideState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="720"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="BackButton.Visibility" Value="Collapsed"/>
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="NarrowState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="BackButton.Visibility" Value="Visible"/>
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <Grid x:Name="ActiveChatGrid" Visibility="Collapsed">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Chat Header -->
            <Grid Height="64" Padding="12,0" Background="{ThemeResource SystemControlBackgroundBaseLowBrush}">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Button x:Name="BackButton" Click="BackButton_Click" 
                            Background="Transparent" Width="48" Height="48" Margin="0,0,4,0">
                        <TextBlock Text="&#xE72B;" FontFamily="{StaticResource IconFont}" FontSize="18"/>
                    </Button>
                    
                    <!-- Avatar with fallback -->
                    <Grid Width="40" Height="40" Margin="0,0,12,0">
                        <!-- Fallback: Colored circle with initial -->
                        <Ellipse x:Name="AvatarFallbackEllipse" Width="40" Height="40" Fill="{StaticResource UnisonGreenBrush}"/>
                        <TextBlock x:Name="AvatarInitialText" Text="" FontSize="16" FontWeight="SemiBold" Foreground="White"
                                   HorizontalAlignment="Center" VerticalAlignment="Center" FontFamily="{StaticResource MainFontSemibold}"/>
                        
                        <!-- Profile picture (circular clip) -->
                        <Ellipse x:Name="AvatarImageEllipse" Width="40" Height="40" Visibility="Collapsed">
                            <Ellipse.Fill>
                                <ImageBrush x:Name="AvatarImageBrush" Stretch="UniformToFill"/>
                            </Ellipse.Fill>
                        </Ellipse>
                    </Grid>
                    
                    <TextBlock x:Name="ChatTitleText" Text="Select a chat" FontSize="16" FontFamily="{StaticResource MainFontSemibold}" VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>

            <!-- Messages List -->
            <ListView Grid.Row="1" x:Name="MessageListView" 
                      ItemTemplateSelector="{StaticResource MessageTemplateSelector}"
                      SelectionMode="None"
                      Padding="0,12">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0"/>
                    </Style>
                </ListView.ItemContainerStyle>
            </ListView>

            <!-- Input Bar -->
            <Grid Grid.Row="2" Padding="12" Background="{ThemeResource SystemControlBackgroundBaseLowBrush}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Button Background="Transparent" Width="40" Height="40" Click="AttachButton_Click">
                    <TextBlock Text="&#xE710;" FontFamily="{StaticResource IconFont}" FontSize="20"/>
                </Button>

                <TextBox Grid.Column="1" x:Name="MessageInput" PlaceholderText="Type a message" 
                         Margin="8,0" VerticalAlignment="Center" BorderThickness="0" 
                         Background="Transparent" KeyDown="MessageInput_KeyDown"/>

                <Button Grid.Column="2" Background="Transparent" Width="40" Height="40" Click="SendButton_Click">
                    <TextBlock Text="&#xE724;" FontFamily="{StaticResource IconFont}" FontSize="20" Foreground="{StaticResource UnisonGreenBrush}"/>
                </Button>
            </Grid>

            <!-- Image Confirmation Dialog -->
            <ContentDialog x:Name="ImagePreviewDialog" Title="Send Image?" PrimaryButtonText="Send" SecondaryButtonText="Cancel" DefaultButton="Primary">
                <StackPanel>
                    <Image x:Name="PreviewImage" MaxHeight="300" Stretch="Uniform"/>
                    <TextBlock x:Name="ImageInfoText" Margin="0,8,0,0" Foreground="#888" FontSize="12"/>
                </StackPanel>
            </ContentDialog>
        </Grid>

        <!-- Empty State -->
        <Grid x:Name="EmptyStateGrid" VerticalAlignment="Center" HorizontalAlignment="Center">
            <StackPanel>
                <TextBlock Text="Select a chat to start messaging" Foreground="#888" FontSize="16" FontFamily="{StaticResource MainFont}"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
